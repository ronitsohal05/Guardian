services:
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"

  db:
    image: mongo:7
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: guardian
      MONGO_INITDB_ROOT_PASSWORD: guardian
    volumes:
      - mongo_data:/data/db

  cv:
    build: ./cv
    ports:
      - "8002:8002"
    environment:
      MODEL_PATH: /app/models/best.onnx
    volumes:
      - ./cv/model/runs_guardian/produce_bakery_yolov8n/weights:/app/models:ro

  api:
    build: ./api
    ports:
      - "5001:5000"
    env_file:
      - .env
    environment:
      FLASK_ENV: ${FLASK_ENV}
      MONGO_URI: ${MONGO_URI}
      MONGO_DB: ${MONGO_DB}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      CV_URL: ${CV_URL}
    depends_on:
      - redis
      - db
      - cv
    volumes:
      - ./api:/app

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - api
    environment:
      VITE_API_URL: http://localhost:5000

  worker:
    build: ./worker
    env_file:
      - .env
    environment:
      MONGO_URI: ${MONGO_URI}
      MONGO_DB: ${MONGO_DB}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      EVENT_STREAM: "events:surplus"
      EVENT_GROUP: "worker-group"
      EVENT_CONSUMER: "worker-1"
      DEDUP_TTL_SECONDS: "900"
    depends_on:
      - redis
      - db

volumes:
  mongo_data:
